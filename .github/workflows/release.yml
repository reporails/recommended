name: Release

on:
  push:
    tags:
      - '[0-9]*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Validate rule structure
        run: |
          errors=0
          for dir in core/*/AILS_*/ agents/*/rules/AILS_*/; do
            [ -d "$dir" ] || continue
            id=$(basename "$dir" | cut -d- -f1)
            slug=$(basename "$dir")
            if [ ! -f "${dir}${slug}.md" ]; then
              echo "ERROR: ${dir} missing ${slug}.md"
              errors=$((errors + 1))
            fi
            if [ ! -f "${dir}${slug}.yml" ]; then
              echo "ERROR: ${dir} missing ${slug}.yml"
              errors=$((errors + 1))
            fi
          done
          if [ "$errors" -gt 0 ]; then
            echo "Found $errors errors"
            exit 1
          fi
          echo "All rule directories valid"

      - name: Generate manifest
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}

          echo "release: \"${VERSION}\"" > manifest.yml
          echo "rules:" >> manifest.yml

          count=0
          for dir in core/*/AILS_*/ agents/*/rules/AILS_*/; do
            [ -d "$dir" ] || continue
            id=$(basename "$dir" | cut -d- -f1)
            slug=$(basename "$dir")
            echo "  ${id}: ${slug}" >> manifest.yml
            count=$((count + 1))
          done

          echo "rule_count: ${count}" >> manifest.yml

      - name: Create tarball
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}

          tar -czvf reporails-recommended-${VERSION}.tar.gz \
            manifest.yml \
            levels.yml \
            core/ \
            agents/ \
            docs/sources.yml

          sha256sum reporails-recommended-${VERSION}.tar.gz > checksums.txt

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
          files: |
            reporails-recommended-*.tar.gz
            checksums.txt
